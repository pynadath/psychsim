"""


TA2A-TA1C-0032-RR.txt

Research method category:
Interview
 
Specific question:
We will send a team of trained survey professionals to regions 2, 6, and 9, and perform a structurected interview all people in these 3 regions (9 people in total, approximately half of the people in the previous survey), to homes, shelters and hospitals and ask the following questions:

0. Ask the following details of participants in the survey:
    a. Age?
    b. Number of Children?
    c. Ethnicity?
    d. Religion?
    e. Full Time Job? (Y/N)
    f. Gender?
    g. Pets? (Y/N)
    h. Residence? (Yes, this region is my response; No, its not)
    i. How many hurricanes have impacted your region this season?
    j. Which hurricane caused the most damage to your region this season?
    k. Housing:
        k1. Did you own a house before this hurricane season began? 
        k2. Was your house destroyed in a previous hurricane    season? 
        k3. Have you ever rebuilt your house in the hurricane season? 
        k4. Sequence all of your experiences in this hurricane season in which your house was destroyed and/or your house was rebuilt (e.g. During hurricane 2, house destroyed; Post hurricane 2, rebuilt; During hurricane 3, destroyed; Pre hurricane 4, rebuilt). 
        k5. How strong is your house to resistance against a hurricane? (Reinforcement level, 1 to 5)

1a. Do you know anyone (be Acquaintances with anyone) outside the region you live in? 
1b. If so, how many people do you know outside the region you live in?

2a. If you have been to the shelter, did you see anyone there? 
2b. Did you become acquaintances with the people you met in the shelter? 
2c. Did you talk with the other people in the shelter? 
2d. What are the contents of these conversations mainly about? (e.g., hurricane, government response, health, uncertainty)

3. How many close friends do you have in the area (closer than acquaintances, but excluding family members)?

4. Questions regarding risk type:
    4a.Has your house been damaged in any of these hurricanes?
    4b.Has your house been destroyed in any of these hurricanes?
    4c.Has your water supply been cut?
    4d.Has your electricity supply been cut?
    4e.Have you been trapped in your house and cannot get out because of the hurricane?
    4f.Describe at most 3 other problems you met during the hurricane not listed above.

5. Describe at most 3 types of things you saw or heard that the government has done in response to a hurricane. (e.g. Providing weather report, providing hurricane warnings, opening shelters, giving compensation, reinforcing houses, compulsory evacuation, etc.)

6. Are you satisfied with government responses to all previous hurricanes? If not, describe at most 3 reasons why you are not satisfied.

7. Do you think government response is FAIR in all those hurricanes? If not, describe at most 3 reasons you think it is unfair.

8. Do you think government response is ADEQUATE in all those hurricanes? If not, describe at most 3 reasons that you think it is inadequate.

9a. If you evacuate, do you evacuate with all your family? 
9b. If not, describe who doesn't evacuate with you (describe his/her relationship to you, e.g children/couple). 
9c. Why doesn't he/she come with you? Do you evacuate with your pets if you have any? 
9d. If you have children, where is your children when you are in a shelter? (for instance: Were they evacuated? Are they protected by the government? Have you sent them to your friends?)

10a. If you have been to a shelter in any hurricanes, did you come with your children? 
10b. Did you come with your pets? 
10c. If you didn't go to the shelter with your children, where are they (eg. are they evacuated? Do they stay at your home in this area? Do you send them to another region? Or do you ask someone you know to take care of the children?)

11a. Have you ever travelled to other regions during this entire season? 
11b. If so, describe to which regions you have travelled, when was the travel, why did you travel, and with whom did you travel?

12. Please describe the policy in your region set by the government to respond to the hurricane. (e.g., how does the government decide who to administer compensation to, who can get compensation and how much?)

13. From the choices below, select all that apply:

Your decision to evacuate in a hurricane will be affected by:
	a1) Whether you were injured in the last hurricane	 
    a2) Whether you were injured in previous hurricanes this season before the last hurricane 
	a3) Whether you were injured in a hurricane during a previous hurricane season
    a4) Whether you were injured at some point in time (including during a non-hurricane season)
	b1) Whether you lost property in the last hurricane 	 
    b2) Whether you lost property in previous hurricanes this season before last hurricane 
    b3) Whether you lost property in a hurricane during a previous hurricane season.
    b4) Whether you lost property at some point in time (including during a non-hurricane season)  
    c1) Whether your acquaintances lost property in the last hurricane 
    c2) Whether your acquaintances lost property in previous hurricanes this season before last hurricane
	c3) Whether your acquaintances lost property in a hurricane during a previous hurricane season.
    c4) Whether your acquaintances lost property at some point in time (including during a non-hurricane season)  
	d1) Whether one or more of your family members were injured in the last hurricane
    d2) Whether one or more of your family members were injured in a hurricane this season before last hurricane
    d3) Whether one or more of your family members were injured in a hurricane during a previous hurricane season
    d4) Whether one or more of your family members were injured at some point in time (including during a non-hurricane season) 
	e1) Whether one or more of your acquaintances were injured in the  last hurricane
    e2) Whether one or more of your acquaintances were injured in a hurricane this season before last hurricane
	e3) Whether one or more of your acquaintances were injured in a hurricane during a previous hurricane season
    e4) Whether one or more of your acquaintances were injured at some point in time (including during a non-hurricane season)
	f) Category of the hurricane
	g) Your location and the hurricane landing location, or last center location of the hurricane. (If yes, describe the specific rule, e.g., If I'm 2 regions away from the centre, I will not evacuate. If I am to the South of the landing area, I will evacuate)
	h) Government policy (example: Because the government will reward $1,000 for each individual who does not to evacuate, I am more likely to stay)
	i) Opinions from your family members (excluding yourself)
	j) Opinions from your close friends
	k) Opinions from your acquaintances

14. What has changed your evaluation of the risk level associated with a hurricane from BEFORE the hurricane arrived to AFTER you have experienced it (corresponding to the risk assessment in "PostActor level")? Select all that apply:
    a1) Whether you were injured in the last hurricane	 
    a2) Whether you were injured in previous hurricanes this season before the last hurricane 
	a3) Whether you were injured in a hurricane during a previous hurricane season
    a4) Whether you were injured at some point in time (including during a non-hurricane season)
	b1) Whether you lost property in the last hurricane 	 
    b2) Whether you lost property in previous hurricanes this season before last hurricane 
    b3) Whether you lost property in a hurricane during a previous hurricane season.
    b4) Whether you lost property at some point in time (including during a non-hurricane season
	c1) Whether your acquaintances lost property in the last hurricane 
    c2) Whether your acquaintances lost property in previous hurricanes this season before last hurricane
	c3) Whether your acquaintances lost property in a hurricane during a previous hurricane season.
    c4) Whether your acquaintances lost property at some point in time (including during a non-hurricane season)  
	d1) Whether one or more of your family members were injured in the last hurricane
    d2) Whether one or more of your family members were injured in a hurricane this season before last hurricane
    d3) Whether one or more of your family members were injured in a hurricane during a previous hurricane season
    d4) Whether one or more of your family members were injured at some point in time (including during a non-hurricane season) 
    e1) Whether one or more of your acquaintances were injured in the last hurricane
    e2) Whether one or more of your acquaintances  were injured in a hurricane this season before last hurricane
    e3) Whether one or more of your acquaintances were injured in a hurricane during a previous hurricane season
    e4) Whether one or more of your acquaintances were injured at some point in time (including during a non-hurricane season) 
	 f) Category of the hurricane
	 g) Your location and the hurricane landing location, or last centre location of the hurricane. (If yes, describe the specific rule, such as: If I am 2 regions away from the centre, I will not evacuate. If I am to the South of the landing area, I will not evacuate)
	 h) Opinions from your family members(excluding yourself)
	 i) Opinions from your close friends
	 j) Opinions from your acquaintances
	 k) The time length you were exposed to the hurricane during the last hurricane (the amount of time you were not evacuated)
	 l) The time length your family are exposed to the hurricane during the last hurricane (the amount of time you were not evacuated)
	 m) Government assistance (If yes, describe the kind of assistance such as: Government helps me reinforce my house)
	 n) Your wealth
	 o) The reinforcement level of your house

15. Under following situations, how likely do you think you will evacuate (for each situation, choose a number between 0 - 100% likely):
10% adults in your region lost property in last hurricane (wealth decreases)
20% adults in your region lost property in last hurricane (wealth decreases)
30% adults in your region lost property in last hurricane (wealth decreases)
40% adults in your region lost property in last hurricane (wealth decreases)
50% adults in your region lost property in last hurricane (wealth decreases)
60% adults in your region lost property in last hurricane (wealth decreases)
70% adults in your region lost property in last hurricane (wealth decreases)
80% adults in your region lost property in last hurricane (wealth decreases)
90% adults in your region lost property in last hurricane (wealth decreases)
100% adults in your region lost property in last hurricane (wealth decreases)
10% of your acquaintances get injured anytime in last hurricane
20% of your acquaintances get injured anytime in last hurricane
30% of your acquaintances get injured anytime in last hurricane
40% of your acquaintances get injured anytime in last hurricane
50% of your acquaintances get injured anytime in last hurricane
60% of your acquaintances get injured anytime in last hurricane
70% of your acquaintances get injured anytime in last hurricane
80% of your acquaintances get injured anytime in last hurricane
90% of your acquaintances get injured anytime in last hurricane
100% of your acquaintances get injured anytime in last hurricane
10% of your acquaintances are currently requiring hospitalization
20% of your acquaintances are currently requiring hospitalization
30% of your acquaintances are currently requiring hospitalization
40% of your acquaintances are currently requiring hospitalization
50% of your acquaintances are currently requiring hospitalization
60% of your acquaintances are currently requiring hospitalization
70% of your acquaintances are currently requiring hospitalization
80% of your acquaintances are currently requiring hospitalization
90% of your acquaintances are currently requiring hospitalization
100% of your acquaintances are currently requiring hospitalization
25% of your family members(including yourself) are currently requiring hospitalization
50% of your family members(including yourself) are currently requiring hospitalization
75% of your family members(including yourself) are currently requiring hospitalization
100% of your family members(including yourself) are currently requiring hospitalization

16. How many of your family members (including yourself) got injured this hurricane season?

17. How many of your acquaintances got injured this hurricane season?

18. Did you have to spend money to evacuate?

19. How much time does it take for you to get to Region 11? If you can use different transportation, please list all possible transportation possibilities, and the time and cost for each transportation. (e.g. By car, 2 days; only people with wealth of at least 3 can afford that)

20. How much time does it take for you to evacuate (leave the area)? If you can use alternative transportation, please list all possible options for transportation, the time required, and the cost for each option. (e.g., By car, 2 days, only people with wealth of at least 3 can afford that)

Sampling strategy:
For residents survey team, survey all people in region 6, 9, and 2, then randomly survey people in other regions if we can afford more.
 
Other applicable detail:
N/A
 
Research request identifier:
TA2A-TA1C-0032-RR

"""
from psychsim.probability import Distribution
from psychsim.action import *
from psychsim.pwl import *
from psychsim.domains.groundtruth.simulation.data import *
from psychsim.domains.groundtruth import accessibility
from psychsim.domains.groundtruth.simulation.cdf import value2dist

if __name__ == '__main__':
    regions = {'Region02','Region06','Region09'}
    parser = accessibility.createParser(output='TA2A-TA1C-0032.tsv',day=True,seed=True)
    args = accessibility.parseArgs(parser)
    data = accessibility.loadFromArgs(args,world=True,hurricanes=True,network=True,runData=True)
    data['hurricanes'] = data['hurricanes'][:6]
    config = accessibility.getConfig(args['instance'])
    # Find pool
    actors = sorted([name for name in data['world'].agents if name[:5] == 'Actor' and data['world'].agents[name].home in regions and data['world'].agents[name].getState('alive').first()])
    regionRisk = {name: [] for name in actors}
    actions = {name: [] for name in actors}
    locations = {name: [] for name in actors}
    occupancy = {}
    health = {name: [] for name in data['world'].agents if name[:5] == 'Actor'}
    children = {name: [] for name in actors}
    pets = {name: [] for name in actors}
    wealth = {name: [] for name in actors}
    hurricane = data['hurricanes'][0]
    grievance = {name: [] for name in actors}
    system = Distribution()
    # Grab time series of some relevant variables
    for row in data['run']:
        t = int(row['Timestep'])
        if t > args['day']:
            break
        if t >= hurricane['Start']:
            if t <= hurricane['End']:
                if row['EntityIdx'] in actors and row['VariableName'] == 'ActorBeliefOfRegion risk':
                    if len(regionRisk[row['EntityIdx']]) < hurricane['Hurricane']:
                        regionRisk[row['EntityIdx']].append([])
                    regionRisk[row['EntityIdx']][hurricane['Hurricane']-1].append(float(value2dist(row['Value'],row['Notes'],float)))
            elif hurricane['Hurricane'] < len(data['hurricanes']):
                # Move on to next hurricane
                hurricane = data['hurricanes'][hurricane['Hurricane']]
        if row['VariableName'] == 'Actor action' and row['EntityIdx'] in actors:
            actions[row['EntityIdx']].append(Action(row['Value']))
        elif row['VariableName'] == 'System action':
            system.addProb(Action(row['Value'])['object'],1)
        elif row['VariableName'] == 'Actor grievance' and row['EntityIdx'] in actors:
            grievance[row['EntityIdx']].append(float(row['Value']))
        elif row['VariableName'] == 'Actor health':
            health[row['EntityIdx']].append(float(row['Value']))
        elif row['VariableName'] == 'Actor childrenHealth' and row['EntityIdx'] in actors:
            children[row['EntityIdx']].append(float(row['Value']))
        elif row['VariableName'] == 'Actor resources' and row['EntityIdx'] in actors:
            wealth[row['EntityIdx']].append(float(row['Value']))
        elif row['VariableName'] == 'Actor pet' and row['EntityIdx'] in actors:
            if row['Value'] == 'True':
                pets[row['EntityIdx']].append(1)
            else:
                pets[row['EntityIdx']].append(0)
        elif row['VariableName'] == 'Actor location':
            if row['Value'][:7] == 'shelter':
                if row['Value'] not in occupancy:
                    occupancy[row['Value']] = {}
                occupancy[row['Value']][t] = occupancy[row['Value']].get(t,set()) | {row['EntityIdx']}
            if row['EntityIdx'] in actors:
                locations[row['EntityIdx']].append(row['Value'])
    assert len(occupancy) == 1
    assert 'shelter11' in occupancy
    system.normalize()
    fields = ['Participant']+sorted(list(demographics.keys()))+['# Hurricanes','Most Damaging Hurricane','Outside Acquaintances','# Outside Acquaintances',
        'People at Shelter','Make Acquaintances','Talk at Shelter','Conversation','Friends','Problem 1','Problem 2','Problem 3','Government 1','Government 2',
        'Government 3','Government 4','Government 5','Satisfied','Dissatisfied 1','Dissatisfied 2','Dissatisfied 3','Fair','Unfair 1','Unfair 2','Unfair 3',
        'Adequate','Inadequate 1','Inadequate 2','Inadequate 3','Evacuate Family','Whom Not Evacuated','Why Not Evacuated','Evacuate Pets','Children When Sheltered',
        'Sheltered with Children','Sheltered with Pets','Children If Not Sheltered','Travel','Travel Where','Travel When','Travel Why','Travel with Whom',
        'Policy','Family Injured','Acquaintances Injured','Evacuation Cost','Region 11 Time','Evacuation Time']
    output = []
    for name in actors:
        agent = data['world'].agents[name]
        assert agent.home == agent.getState('region').first()
        record = {'Participant': len(output)+1}
        output.append(record)
        # 0.a-g
        record.update(getDemographics(agent))
        # 0.h
        assert record['Residence'] in regions
#        record['Residence'] = 'Yes'
        # 0.i
        record['# Hurricanes'] = len(data['hurricanes'])
        # 0.j
        values = [(max(regionRisk[name][h]),h+1) for h in range(len(data['hurricanes']))]
        record['Most Damaging Hurricane'] = max(values)[1]
        # 1a.
        friends = {friend for friend in data['network']['friendOf'][name] \
            if data['world'].agents[friend].home != agent.home}
        if friends:
            record['Outside Acquaintances'] = 'yes'
        else:
            record['Outside Acquaintances'] = 'no'
        # 1a.
        record['# Outside Acquaintances'] = len(friends)
        # 2a-d.
        days = [t for t in range(len(locations[name])) if locations[name][t] == 'shelter11']
        if days:
            people = [occupancy['shelter11'][t+1] for t in days]
            if max([len(p) for p in people]) > 0:
                record['People at Shelter'] = 'yes'
            else:
                record['People at Shelter'] = 'no'
            record['Make Acquaintances'] = 'no'
            talk = [len(p & data['network']['friendOf'][name]) for p in people]
            if max(talk) > 0:
                record['Talk at Shelter'] = 'yes'
                record['Conversation'] = 'hurricane'
            else:
                record['Talk at Shelter'] = 'no'
                record['Conversation'] = 'NA'
        else:
            record['People at Shelter'] = 'NA'
            record['Make Acquaintances'] = 'NA'
            record['Talk at Shelter'] = 'NA'
            record['Conversation'] = 'NA'
        # 3
        record['Friends'] = len(data['network']['friendOf'][name])
        # 4f
        problems = []
        if health[name][0]-min(health[name]) > 0:
            problems.append(('My health suffered',health[name][0]-min(health[name])))
        if wealth[name][0]-min(wealth[name]) > 0:
            problems.append(('My wealth suffered',wealth[name][0]-min(wealth[name])))
        if agent.getState('children').first() > 0 and children[name][0]-min(children[name]) > 0:
                problems.append(('My children\'s health suffered',children[name][0]-min(children[name])))
        if agent.getState('pet').first() and pets[name][0]-min(pets[name]) > 0:
            problems.append(('My pet died',pets[name][0]-min(pets[name])))
        problems.sort()
        for i in range(len(problems)):
            record['Problem %d' % (i+1)] = problems[i][0]
        # 5
        remaining = Distribution(system)
        for i in range(min(5,len(system))):
            action = remaining.sample()
            record['Government %d' % (i+1)] = 'Gave aid to %s' % (action)
            del remaining[action]
            remaining.normalize()
        # 6
        if grievance[name][-1] > 0.5:
            record['Satisfied'] = 'no'
            if agent.home in system:
                record['Dissatisfied 1'] = 'Did not help me enough'
            else:
                record['Dissatisfied 1'] = 'Did not help me'
        else:
            record['Satisfied'] = 'yes'
            for i in range(3):
                record['Dissatisfied %d' % (i+1)] = 'NA'
        # 7
        record['Fair'] = 'yes'
        for i in range(3):
            record['Unfair %d' % (i+1)] = 'NA'
        # 8
        if grievance[name][-1] > 0.5:
            record['Adequate'] = 'no'
            if agent.home in system:
                record['Inadequate 1'] = 'Did not help me enough'
            else:
                record['Inadequate 1'] = 'Did not help me'
        else:
            record['Adequate'] = 'yes'
            for i in range(3):
                record['Inadequate %d' % (i+1)] = 'NA'
        # 9a
        if 'evacuated' in locations[name]:
            record['Evacuate Family'] = 'yes'
        else:
            record['Evacuate Family'] = 'NA'
       # 9b
        record['Whom Not Evacuated'] = 'NA'
        # 9c
        record['Why Not Evacuated'] = 'NA'
        if 'evacuated' in locations[name] and agent.getState('pet').first():
            record['Evacuate Pets'] = 'yes'
        else:
            record['Evacuate Pets'] = 'NA'
        # 9d
        if 'shelter11' in locations[name] and agent.getState('children').first() > 0:
            record['Children When Sheltered'] = 'shelter'
        else:
            record['Children When Sheltered'] = 'NA'
        # 10a
        if 'shelter11' in locations[name] and agent.getState('children').first() > 0:
            record['Sheltered with Children'] = 'yes'
        else:
            record['Sheltered with Children'] = 'NA'
        # 10b
        if 'shelter11' in locations[name] and agent.getState('pet').first():
            if config.getboolean('Shelter','pets'):
                record['Sheltered with Pets'] = 'yes'
            else:
                record['Sheltered with Pets'] = 'no'
        else:
            record['Sheltered with Pets'] = 'NA'
        # 10c
        record['Children If Not Sheltered'] = 'NA'
        # 11a and 11b
        travel = {loc for loc in locations[name]} - {'evacuated','shelter11',agent.home}
        if travel:
            record['Travel'] = 'yes'
            raise RuntimeError('Have not yet implemented human-like answer to where/when')
        else:
            record['Travel'] = 'no'
            record['Travel Where'] = 'NA'
            record['Travel When'] = 'NA'
            record['Travel Why'] = 'NA'
            record['Travel with Whom'] = 'NA'
        # 12
        record['Policy'] = 'Don\'t Know'
        # 16
        record['Family Injured'] = 0
        if min(health[name]) < 0.2:
            record['Family Injured'] += 1
        if agent.getState('children').first() > 0 and min(children[name]) < 0.2:
            record['Family Injured'] += 1
        # 17
        record['Acquaintances Injured'] = len({f for f in data['network']['friendOf'][name] if min(health[f]) < 0.2})
        # 18
        evacuation = {t for t in range(len(actions[name])) if actions[name][t]['verb'] == 'evacuate'} - {0}
        if evacuation:
            action = ActionSet([Action({'subject': name,'verb': 'evacuate'})])
            tree = data['world'].getDynamics('%s\'s resources' % (name),action)[0]
            record['Evacuation Cost'] = 'no'
            for t in evacuation:
                vec = KeyedVector({stateKey(name,'resources'): wealth[name][t-1],CONSTANT: 1.})
                if (tree*vec)[stateKey(name,'resources',True)] < wealth[name][t-1]:
                    record['Evacuation Cost'] = 'yes'
                    break
        else:
            record['Evacuation Cost'] = 'NA'
        # 19
        record['Region 11 Time'] = 1
        # 20
        record['Evacuation Time'] = 1
    accessibility.writeOutput(args,output,fields)
